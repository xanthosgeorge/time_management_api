pipeline {
  agent {
    docker {
      image 'jenkins/jenkins:lts'
      args '-v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  environment {
    SNYK_TOKEN = '972a6755-980c-4c60-bfc6-f499b52a418e'
  }

  stages {
    stage('Start Services') {
      steps {
        sh 'docker-compose up -d jenkins sonarqube zaproxy'
        sleep(time: 30, unit: 'SECONDS') // wait for services to initialize
      }
    }

    stage('Run Semgrep') {
      steps {
        sh 'docker-compose run --rm semgrep'
      }
    }

    stage('Run TruffleHog') {
      steps {
        sh 'docker-compose run --rm trufflehog'
      }
    }

    stage('Run Snyk') {
      steps {
        sh 'docker-compose run --rm snyk'
      }
    }

    stage('Run SQLMap') {
      steps {
        sh 'docker-compose run --rm sqlmap'
      }
    }

    stage('Run Nmap') {
      steps {
        sh 'docker-compose run --rm nmap'
      }
    }
  }

  post {
    always {
      sh 'docker-compose down'
      archiveArtifacts artifacts: '*.txt', allowEmptyArchive: true
    }
  }
}
